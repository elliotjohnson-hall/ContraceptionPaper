---
author: Elliot Johnson-Hall
date: '`r format(Sys.Date())`'
title: "Contraception and Covid-19 Restrictions in Scotland"
geometry: margin=0.5in
header-includes:
   - \usepackage{helvet}
   - \usepackage[T1]{fontenc}
mainfont: Helvetica
output:
  pdf_document:
    latex_engine: xelatex
    keep_md: true
    fig_width: 10.0
    #fig_height:
    includes:
        in_header: header.tex
---
# Setup Chunks

```{r Setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, error = TRUE, dev="cairo_pdf")
```

```{r LoadLibraries, message=FALSE, warning=FALSE}
if(!require(pacman))install.packages("pacman")
pacman::p_load("gtExtras", "tidyverse", "lubridate", "readxl", "ggplot2", "sf",
               "gt", "here", "colorspace", "patchwork", "scales", "formatR",
               "broom", "ggspatial", "mapview")
```

# Data Import and Wrangle

## Setup custom functions

```{r CustomFunctions}
#This function will perform an analysis pipeline on the data in a DRY way.
Wrangle <- function(DatasetToWrangle) {
  DatasetToWrangle <- DatasetToWrangle %>%
    filter(GPPractice %in% GPPractices$GPPractice) %>%
    mutate(HB = case_when(is.na(HBT) ~ HBT2014, !is.na(HBT) ~ HBT)) %>%
    select(-c(HBT2014, HBT, ClassOfPreparationCode, NumberOfPaidItems, GrossIngredientCost))
  DatasetToWrangle <-
    full_join(DatasetToWrangle, HealthBoards, by = "HB") %>%
    full_join(., GPPractices, by = "GPPractice") %>%
    mutate(HB = HB.x) %>%
    full_join(., SIMD, by = c("DataZone", "HB"))%>%
    select(-c(HB.x, HB.y, DZ, HBcode)) %>%
    drop_na() %>%
    mutate(HealthBoard = HB, SIMDOverallRank = SIMD2020v2_Vigintile, SIMDHealthRank = SIMD2020_Health_Domain_Rank, UrbanRuralCode = URclass, UrbanRuralDescription = URname) %>%
    select(-c(HB, SIMD2020v2_Vigintile, SIMD2020_Health_Domain_Rank, URclass, URname)) %>%
    mutate(HealthBoard = as.factor(HealthBoard), SIMDOverallRank = as.factor(SIMDOverallRank), SIMDHealthRank = as.factor(SIMDHealthRank), UrbanRuralCode = as.factor(UrbanRuralCode), UrbanRuralDescription = as.factor(UrbanRuralDescription), Postcode = as.factor(Postcode), DataZone = as.factor(DataZone), HealthBoardName = as.factor(HealthBoardName), HealthBoardCode = as.factor(HealthBoardCode), GPPractice = as.factor(GPPractice), PaidDateMonth = ymd(PaidDateMonth))
  return(DatasetToWrangle)
  }

#This zooms in on dates around lockdowns for plotting
Zoom <- function(DatasetToZoom) {
  DatasetToZoom %>%
  group_by(PaidDateMonth) %>%
  filter(as_date(PaidDateMonth) >= as_date("2020-01-01")) %>%
  summarise(SumPaidQuantity = sum(PaidQuantity), .groups = 'drop') %>%
  mutate(PercentageChange = round(((SumPaidQuantity / lag(SumPaidQuantity)) - 1), 1))
  }

#Highlights periods of lockdown
AnnotateLockdowns <- function(Plot) {
  annotate(geom = "rect",
    xmin = c(dmy("23/03/2020"), dmy("26/12/2020"), dmy("26/12/2021")),
    xmax = c(dmy("19/07/2020"), dmy("16/04/2021"), dmy("21/03/2022")),
    ymin = c(-Inf, -Inf, -Inf),
    ymax = c(Inf, Inf, Inf),
  fill = "yellow", alpha = 0.25)
  }

#Highlights periods of one month after lockdown lifting
AnnotateFreeMonth <- function(Plot) {
  annotate(
    geom = "rect",
    xmin = c(dmy("19/07/2020"), dmy("16/04/2021"), dmy("21/03/2022")),
    xmax = c(dmy("19/08/2020"), dmy("16/05/2021"), dmy("21/04/2022")),
    ymin = c(-Inf,-Inf,-Inf),
    ymax = c(Inf, Inf, Inf),
    fill = "green",
    alpha = 0.25
  )
}

#Custom ggplot theme
ThemeElliot <- function(Plot) {
  theme_minimal(base_size=10) %+replace%
    theme(
      legend.position = "none",
      plot.title = element_text(hjust = 0.5, face = "bold", size = 14, margin = margin(0, 0, 5, 0)),
      panel.grid.minor.y=element_blank(),
      axis.title.y = element_text(angle = 90, margin = margin(r = 5)),
      axis.text.y = element_text(angle = 45),
      strip.text = element_text(face = "italic"),
      axis.title.y.right = element_text(angle = 90),
      axis.text.x.bottom =
        element_text(angle = 45, margin = margin(t = 10)),
    plot.margin = margin(5, 5, 5, 5))
  }

SIMDPopulationLookup <- function(Dataset, SIMDRank) {
  Dataset %>%
    filter(SIMDOverallRank == SIMDRank) %>%
    distinct(Population) %>%
    summarise((sum(Population)) * Proportion)
}

SIMDContraceptionLookup <- function(Dataset, SIMDRank) {
Dataset %>%
  filter(SIMDOverallRank == SIMDRank) %>%
  mutate(NumberHealthBoards = n_distinct(HealthBoardCode)) %>%
  select(c(NumberHealthBoards, PaidQuantity, PaidDateMonth)) %>%
  group_by(PaidDateMonth) %>%
  mutate(ContraceptionPerHeadPerMonthPerHealthBoard = as.numeric((PaidQuantity/NumberHealthBoards)/SIMDPopulationLookup(Dataset, SIMDRank))) %>%
    distinct(.)
  }

SIMDPlot <- function(Dataset) {
  Dataset %>%
  group_by(PaidDateMonth) %>%
  ggplot(aes(x = PaidDateMonth, y = ContraceptionPerHeadPerMonthPerHealthBoard)) +
  geom_line() +
  AnnotateLockdowns() +
  AnnotateFreeMonth() +
  ThemeElliot()
}

```

## Prescriptions in the Community Data

This chunk builds a tibble of the two vectors above. It also includes some use
of `lubridate` functions to perform some data wrangling.

This chunk imports all the data from the NHS Scotland Open Data website and
stores each month as an R dataframe. This will take an hour or more to run!

```{r URLWrangle, message=FALSE, results='hide', eval=FALSE}
URLList <- read_csv("https://raw.githubusercontent.com/s1906007/expert-octo-pancake/main/Data/URLList.csv") %>%
  mutate(YearMonths = ym(YearMonths)) %>%
  mutate(Month = month(YearMonths)) %>%
  mutate(Year = year(YearMonths))
#Wrangle
URLList <- URLList %>%
  mutate(MonthYear = paste0(Year, Month))
for (row in 1:nrow(URLList)) {
  assign(paste0("DF", URLList$MonthYear[row]), read_csv(URLList$URLs[row]))
  row = row + 1}
#RegExBindDataFrames
DFList <- mget(ls(pattern = "DF20"))
CompletePrescriptionDataset <- bind_rows(DFList)
rm(list = ls(pattern = "DF"))
```
